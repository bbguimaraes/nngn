local entity = require "nngn.lib.entity"
local map = require "nngn.lib.map"
local player = require "nngn.lib.player"
local texture = require "nngn.lib.texture"

local entities = {}
local warp
local tex <close> = texture.load("img/chrono_trigger/cathedral.png")

local function init()
    -- warp
    table.insert(entities, entity.load(nil, nil, {
        pos = {0, -256},
        renderer = {
            type = Renderer.SPRITE, tex = tex.tex, size = {32, 32},
            scale = {512//16, 512//16}, coords = {0, 2}},
        collider = {
            type = Collider.AABB, bb = 32, flags = Collider.TRIGGER}}))
    warp = entities[#entities]
    -- lights
    for _, pos in ipairs({{-40, 136, 36}, {0, 136, 56}, {40, 136, 36}}) do
        table.insert(entities, entity.load(nil, nil, {
            pos = pos, light = {
                type = Light.POINT,
                color = {1, 1, 1, 1}, att = 512, spec = 0}}))
    end
    for _, t in ipairs({
        -- back left wall
        {{ -88, 176}, nil, {16, 64}, {16, 14, 17, 18}, -48},
        {{ -88, 136}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        {{ -72, 176}, nil, {16, 64}, {16, 14, 17, 18}, -48},
        {{ -72, 136}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        {{ -56, 216}, nil, {16, 16}, {22, 21, 24, 22}, -88},
        {{ -56, 184}, nil, {16, 48}, {16, 19, 17, 22}, -56},
        {{ -56, 152}, nil, {16, 16}, {22, 18, 23, 19}, -24},
        {{ -56, 136}, {-8, -8, 8, 8}, {16, 16}, {16, 18, 17, 19}, nil},
        -- back wall
        {{ -40, 216}, nil, {16, 16}, {16, 17, 17, 18}, -72},
        {{ -40, 200}, nil, {16, 16}, {16, 16, 17, 17}, -56},
        {{ -40, 176}, nil, {16, 32}, {17, 14, 18, 16}, -32},
        {{ -40, 152}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        {{ -24, 232}, nil, {16, 16}, {22, 21, 24, 22}, -88},
        {{ -24, 200}, nil, {16, 48}, {16, 19, 17, 22}, -56},
        {{ -24, 168}, nil, {16, 16}, {22, 18, 23, 19}, -24},
        {{ -24, 152}, nil, {16, 16}, {16, 18, 17, 19}, nil},
        {{  -8, 168}, nil, {16, 16}, {16, 14, 17, 15}, -24},
        {{  -8, 152}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        {{  -8, 232}, nil, {16, 16}, {16, 17, 17, 18}, -32},
        {{   0, 200}, {-48, -56, 48, -40}, {32, 48}, {27, 14, 29, 17}, -56},
        {{   8, 232}, nil, {16, 16}, {16, 17, 17, 18}, -32},
        {{   8, 168}, nil, {16, 16}, {16, 14, 17, 15}, -24},
        {{   8, 152}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        {{  24, 232}, nil, {16, 16}, {22, 21, 24, 22}, -88},
        {{  24, 200}, nil, {16, 48}, {16, 19, 17, 22}, -56},
        {{  24, 168}, nil, {16, 16}, {22, 18, 23, 19}, -24},
        {{  24, 152}, nil, {16, 16}, {16, 18, 17, 19}, nil},
        {{  40, 216}, nil, {16, 16}, {16, 17, 17, 18}, -72},
        {{  40, 200}, nil, {16, 16}, {16, 16, 17, 17}, -56},
        {{  40, 176}, nil, {16, 32}, {17, 14, 18, 16}, -32},
        {{  40, 152}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        -- back right wall
        {{56, 216}, nil, {16, 16}, {22, 21, 24, 22}, -88},
        {{56, 184}, nil, {16, 48}, {16, 19, 17, 22}, -56},
        {{56, 152}, nil, {16, 16}, {22, 18, 23, 19}, -24},
        {{56, 136}, {-8, -8, 40, 8}, {16, 16}, {16, 18, 17, 19}, nil},
        {{72, 176}, nil, {16, 64}, {16, 14, 17, 18}, -48},
        {{72, 136}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        {{88, 176}, nil, {16, 64}, {16, 14, 17, 18}, -48},
        {{88, 136}, nil, {16, 16}, {21, 10, 22, 11}, nil},
        -- altar
        {{-16, 120}, {-12, -8, 44, 12}, {32, 16}, {26, 17, 28, 18}, nil},
        {{ 16, 120},               nil, {32, 16}, {27, 17, 29, 18}, nil},
        -- organ
        {{ -80, 136}, {-16, -16, 16, -8}, {32, 48}, {18, 11, 20, 14}, -24},
        -- left pillar
        {{ -88, -23},               nil, {16, 16}, {22, 17, 23, 18}, -72},
        {{ -88, -63}, {-8, -32, 0, -16}, {16, 64}, {21, 18, 22, 22}, -32},
        -- right pillar
        {{  88, -23},               nil, {16, 16}, {19, 17, 20, 18}, -72},
        {{  88, -63}, { 0, -32, 8, -16}, {16, 64}, {20, 18, 21, 22}, -32},
        -- benches
        {{-56,  -47}, nil, {16, 32}, {21, 15, 22, 17}, nil},
        {{-40,  -39}, nil, {16, 16}, {22, 16, 23, 17}, -24},
        {{-40,  -55}, {-24, -8, 24, 8}, {16, 16}, {24, 17, 25, 18}, nil},
        {{-24,  -47}, nil, {16, 32}, {24, 15, 25, 17}, nil},
        {{ 56,  -47}, nil, {16, 32}, {24, 15, 25, 17}, nil},
        {{ 40,  -39}, nil, {16, 16}, {22, 16, 23, 17}, -24},
        {{ 40,  -55}, {-24, -8, 24, 8}, {16, 16}, {24, 17, 25, 18}, nil},
        {{ 24,  -47}, nil, {16, 32}, {21, 15, 22, 17}, nil},
        {{-56,  -95}, nil, {16, 32}, {21, 15, 22, 17}, nil},
        {{-40,  -87}, nil, {16, 16}, {22, 16, 23, 17}, -24},
        {{-40, -103}, {-24, -8, 24, 8}, {16, 16}, {24, 17, 25, 18}, nil},
        {{-24,  -95}, nil, {16, 32}, {24, 15, 25, 17}, nil},
        {{ 56,  -95}, nil, {16, 32}, {24, 15, 25, 17}, nil},
        {{ 40,  -87}, nil, {16, 16}, {22, 16, 23, 17}, -24},
        {{ 40, -103}, {-24, -8, 24, 8}, {16, 16}, {24, 17, 25, 18}, nil},
        {{ 24,  -95}, nil, {16, 32}, {21, 15, 22, 17}, nil},
        {{-56, -143}, nil, {16, 32}, {21, 15, 22, 17}, nil},
        {{-40, -135}, nil, {16, 16}, {22, 16, 23, 17}, -24},
        {{-40, -151}, {-24, -8, 24, 8}, {16, 16}, {24, 17, 25, 18}, nil},
        {{-24, -143}, nil, {16, 32}, {24, 15, 25, 17}, nil},
        {{ 56, -143}, nil, {16, 32}, {24, 15, 25, 17}, nil},
        {{ 40, -135}, nil, {16, 16}, {22, 16, 23, 17}, -24},
        {{ 40, -151}, {-24, -8, 24, 8}, {16, 16}, {24, 17, 25, 18}, nil},
        {{ 24, -143}, nil, {16, 32}, {21, 15, 22, 17}, nil},
        -- front left wall
        {{ -80, -184}, nil, {32, 16}, {21, 29, 23, 30}, -72},
        {{ -72, -200}, nil, {16, 16}, {21, 28, 22, 29}, -56},
        {{ -48, -200}, nil, {32, 16}, {21, 29, 23, 30}, -56},
        {{ -40, -216}, nil, {16, 16}, {23, 26, 24, 27}, -40},
        {{ -24, -216}, nil, {16, 16}, {30, 29, 31, 30}, -40},
        -- front right wall
        {{  24, -216}, nil, {16, 16}, {29, 29, 30, 30}, -40},
        {{  40, -216}, nil, {16, 16}, {28, 26, 29, 27}, -40},
        {{  48, -200}, nil, {32, 16}, {17, 29, 19, 30}, -56},
        {{  72, -200}, nil, {16, 16}, {18, 28, 19, 29}, -56},
        {{  80, -184}, nil, {32, 16}, {17, 29, 19, 30}, -72},
        -- front wall
        {{-104, -192}, nil, {16, 32}, {16,  0, 17,  1}, -64},
        {{ -88, -200}, nil, {16, 16}, {16,  0, 17,  1}, -56},
        {{ -72, -216}, nil, {48, 16}, {16,  0, 17,  1}, -40},
        {{ -64, -232}, nil, {64, 16}, {16,  0, 17,  1}, -24},
        {{ -24, -232}, nil, {16, 16}, {23, 26, 24, 27}, -40},
        {{   0, -232}, nil, {32, 16}, {19, 29, 21, 30}, -40},
        {{  24, -232}, nil, {16, 16}, {28, 26, 29, 27}, -40},
        {{  64, -232}, nil, {64, 16}, {16,  0, 17,  1}, -24},
        {{  72, -216}, nil, {48, 16}, {16,  0, 17,  1}, -40},
        {{  88, -200}, nil, {16, 16}, {16,  0, 17,  1}, -56},
        {{ 104, -192}, nil, {16, 32}, {16,  0, 17,  1}, -64},
    }) do
        local bb = t[2]
        t = {
            pos = t[1], renderer = {
                type = Renderer.SPRITE,
                tex = tex.tex, size = t[3], z_off = t[5],
                scale = {512//16, 512//16}, coords = t[4]}}
        if bb then
            t.collider = {
                type = Collider.AABB,
                bb = bb, m = Math.INFINITY, flags = Collider.SOLID}
        end
        table.insert(entities, entity.load(nil, nil, t))
    end
    -- altar top
    for _, t in ipairs({
        {{-16, 136}, {26, 18, 28, 19}},
        {{ 16, 136}, {27, 18, 29, 19}},
    }) do
        table.insert(entities, entity.load(nil, nil, {
            pos = t[1], renderer = {
                type = Renderer.SPRITE,
                tex = tex.tex, size = {32, 16}, z_off = -24,
                scale = {512//16, 512//16}, coords = t[2]}}))
    end
    for _, t in ipairs({
        -- left wall
        {{-104,   8}, {-24, -208,  8, 112}, { 1,  3,  2, 28}},
        -- right wall
        {{ 104,   8}, { -8, -208, 24, 120}, {14,  3, 15, 28}},
    }) do
        table.insert(entities, entity.load(nil, nil, {
            pos = t[1],
            renderer = {
                type = Renderer.SPRITE,
                tex = tex.tex, size = {16, 400}, z_off = -268,
                scale = {512//16, 512//16}, coords = t[3]},
            collider = {
                type = Collider.AABB,
                bb = t[2], m = Math.INFINITY, flags = Collider.SOLID}}))
    end
    -- rotated walls
    for _, t in ipairs({
        {{-60, -227}, {-45, -8, 45, 8}, math.rad(-27)},
        {{ 60, -227}, {-45, -8, 45, 8}, math.rad( 27)},
    }) do
        table.insert(entities, entity.load(nil, nil, {
            pos = t[1], collider = {
                type = Collider.BB,
                bb = t[2], rot = t[3], m = Math.INFINITY,
                flags = Collider.SOLID}}))
    end
    entities = entities
    nngn.lighting:set_ambient_light(.125, .125, .125, 1)
    nngn.lighting:set_shadows_enabled(true)
    nngn.lighting:set_zsprites(true)
    nngn.renderers:set_zsprites(true)
    player.move_all(0, -236, true)
end

map.map {
    name = "cathedral",
    file = "maps/cathedral.lua",
    state = {
        ambient_light = true, shadows_enabled = true, zsprites = true},
    init = init,
    entities = entities,
    on_collision = function(e0, e1)
        if e0 == warp or e1 == warp then map.next("maps/main.lua") end
    end,
    tiles = {tex.tex, 2, 0, 0, 256, 256, 1, 2, {0, 0, 0, 1}},
}
